# SubMaker - Stremio Subtitle Translator
# Environment Configuration

# ======================
# REQUIRED - API Keys and Server Configuration
# ======================

# OpenSubtitles Developer API Key (REQUIRED)
OPENSUBTITLES_API_KEY=

# Stremio Community Subtitles Manifest Token (OPTIONAL)
# Get this from https://stremio-community-subtitles.top/
# If provided, enables searching community subtitles
SCS_MANIFEST_TOKEN=

# Subs.ro API Key (PER-USER - not server-wide)
# Subs.ro is a Romanian subtitle database that requires an API key for access.
# Users can generate their own API key from their profile at https://subs.ro
# This is configured per-user in the addon configuration page, not as an env variable.
# The API supports search by IMDB ID, TMDB ID, title, and release name.
# Languages supported: Romanian (ro), English (en), Italian, French, German,
# Hungarian, Greek, Portuguese, Spanish, and other (alt).

# Port to run the server on (default: 7001)
PORT=7001

# Node environment: development or production
NODE_ENV=production

# Reverse proxy trust setting (IMPORTANT for production deployments)
# Set this when running behind a reverse proxy (nginx, Cloudflare, etc.)
# Without this, rate limiting and IP detection will not work correctly.
# Values: 1 (one proxy hop), 2 (two hops), "loopback", "linklocal", "uniquelocal",
#          or a comma-separated list of trusted proxy subnets (e.g., "10.0.0.0/8")
# Default: false (no proxy trust - safe for direct exposure)
# TRUST_PROXY=1

# Log level: 'debug' (all logs), 'warn' (warnings + errors), 'error' (errors only)
LOG_LEVEL=error

# Storage type: "redis" (default) or "filesystem"
# Use "filesystem" for local development with npm start
# Use "redis" for production/HA deployment with Docker
STORAGE_TYPE=redis

# Encryption key for sensitive user data (API keys, passwords)
# Must be 64 hex characters (32 bytes) for AES-256-GCM encryption
# If not provided, a key will be auto-generated and saved to .encryption-key file
# Generate a key: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
# ENCRYPTION_KEY=

# ======================
# IMPORTANT - Storage Configuration
# ======================

# Redis Configuration (only needed if STORAGE_TYPE=redis)
REDIS_HOST=localhost
REDIS_PORT=6379
# Redis password (optional - leave empty for no authentication)
# Note: If using docker-compose.yaml, you must also update the Redis server
# command to enable password authentication (see comments in docker-compose.yaml)
REDIS_PASSWORD=
# Redis password file (optional). If set, SubMaker will auto-generate a strong password and
# save it to this path (0600) when missing. Mount this path to a persistent volume and configure
# your Redis server to load the same file (docker-compose.yaml does this for you).
# If REDIS_PASSWORD is set, that value is used (and written to the file if missing).
# REDIS_PASSWORD_FILE=./keys/.redis-password
REDIS_DB=0
# Keep this value identical (including trailing colon) across all pods/instances
# to share the same cache/session namespace. Do not mix colon/no-colon variants.
REDIS_KEY_PREFIX=stremio

# ======================
# Redis High Availability (OPTIONAL - Enterprise Deployments)
# ======================

# Redis Sentinel for automatic failover (disabled by default)
# Only enable this for production HA deployments with Redis Sentinel
# Single-user deployments should leave this disabled
# REDIS_SENTINEL_ENABLED=false

# Sentinel configuration (only used if REDIS_SENTINEL_ENABLED=true)
# Comma-separated list of sentinel nodes (host:port)
# Example: REDIS_SENTINELS=sentinel1:26379,sentinel2:26379,sentinel3:26379
# REDIS_SENTINELS=localhost:26379

# Sentinel master name (default: mymaster)
# REDIS_SENTINEL_NAME=mymaster

# Cache Size Limits (in bytes)
# CRITICAL: Total cache size MUST be less than Redis maxmemory setting!
# Default: 3GB total (fits in 4GB Redis with 1GB overhead)
#
# For larger deployments with more RAM:
# - Set Redis maxmemory to 16GB and use: CACHE_LIMIT_TRANSLATION=6442450944 (6GB)
# - Or set to 120GB+ and increase proportionally
# - Example: CACHE_LIMIT_TRANSLATION=53687091200 (50GB) for enterprise deployments
#
# CACHE_LIMIT_TRANSLATION=1610612736  # 1.5GB (default) - permanent translations - was 6442450944 (6GB) for 16GB Redis
# CACHE_LIMIT_BYPASS=536870912        # 0.5GB (default) - temporary user cache (12h TTL) - was 2147483648 (2GB) for 16GB Redis
# CACHE_LIMIT_PARTIAL=536870912       # 0.5GB (default) - in-progress translations (1h TTL) - was 2147483648 (2GB) for 16GB Redis
# CACHE_LIMIT_SYNC=536870912          # 0.5GB (default) - synced subtitles - was 2147483648 (2GB) for 16GB Redis
# CACHE_LIMIT_EMBEDDED=536870912      # 0.5GB (default) - embedded subtitle cache (original + translated)

# 3-click cache reset rate limits (per user/config)
# Defaults: 6 resets / 15 minutes for permanent cache, 12 / 15 minutes for bypass cache
# CACHE_RESET_LIMIT_TRANSLATION=6
# CACHE_RESET_LIMIT_BYPASS=12
# CACHE_RESET_WINDOW_MINUTES=15

# ======================
# AI Translation Configuration (ADVANCED)
# ======================

# Default Gemini model to use for translations (optional, fallback)
# Examples: gemini-2.0-flash-exp, gemini-2.5-flash-latest, gemini-2.5-pro-latest
# GEMINI_MODEL=gemini-flash-latest

# Extended thinking mode for translations (default: 0 = disabled)
# Controls how many tokens the AI uses for "thinking" before responding
# - 0: Disabled (faster, uses default AI reasoning)
# - -1: Dynamic thinking (AI decides how much thinking time needed)
# - 1000-32000: Fixed token budget for thinking (higher = more careful reasoning)
# Note: Thinking tokens count toward API usage and reduce available output tokens
# Recommendation: -1 for quality, 0 for speed, >0 for controlled thinking
# GEMINI_THINKING_BUDGET=0

# Translation creativity/temperature (default: 0.8)
# Controls randomness in translations (0.0 = deterministic, 2.0 = very creative)
# - 0.0-0.3: Very consistent, literal translations
# - 0.4-0.8: Balanced - natural while staying accurate (recommended)
# - 0.9-1.5: More creative, varied phrasing
# - 1.6-2.0: Very creative, may deviate from source
# GEMINI_TEMPERATURE=0.8

# Top-K sampling for translation diversity (default: 40)
# Limits the number of highest probability tokens considered
# Lower = more focused, Higher = more diverse
# Range: 1-100, recommended: 20-60
# GEMINI_TOP_K=40

# Top-P (nucleus) sampling for translation quality (default: 0.95)
# Cumulative probability threshold for token selection
# - 0.9: More conservative, predictable translations
# - 0.95: Balanced (recommended)
# - 0.99: More diverse, creative translations
# GEMINI_TOP_P=0.95

# Maximum output tokens per API call (default: 65536)
# Limits the length of generated translations
# Note: Actual limit depends on the model (2.0 models: 8192, 2.5 models: 65536)
# GEMINI_MAX_OUTPUT_TOKENS=65536

# API timeout for translation requests in seconds (default: 600)
# How long to wait for translation API responses before timing out
# Increase for very long subtitle files or slow network connections
# GEMINI_TRANSLATION_TIMEOUT=600

# Maximum retry attempts for failed API calls (default: 3)
# Number of times to retry on 429 rate limits, 503 service unavailable, timeouts, and network errors
# Uses exponential backoff: 3s, 6s, 12s delays between retries
# Set to 0 to disable retries (fail immediately)
# GEMINI_MAX_RETRIES=3

# Maximum number of Gemini API keys allowed for key rotation (default: 5)
# Users can add up to this many API keys in the config page when rotation is enabled
# Higher values allow more keys for load distribution, but increase config complexity
# MAX_GEMINI_API_KEYS=5

# ======================
# File Upload Translation (Batch UX)
# ======================

# Maximum number of subtitle files that can be queued from the file-upload page
# Defaults to 10; lower to tighten client-side batching or raise (carefully) for power users
# FILE_UPLOAD_MAX_BATCH_FILES=10

# Maximum concurrent translations from the file-upload page queue (client-side only)
# Defaults to 1 to avoid API rate limits; increase cautiously if your API quota allows
# FILE_UPLOAD_MAX_CONCURRENCY=1

# ======================
# Parallel Translation (DEPRECATED) (ADVANCED - File Upload Page)
# ======================

# Parallel translation for large SRT files (file upload page only)
# Splits large files into chunks and translates them concurrently for better performance
# Each chunk includes context from surrounding entries to maintain translation coherence

# Token threshold to enable parallel translation (default: 15000)
# Files larger than this will be split into chunks and translated in parallel
# Files smaller than this use a single API call
# Set higher to use single-call more often, lower to use parallel more often
# PARALLEL_TRANSLATION_THRESHOLD=15000

# Maximum concurrent API calls (default: 3)
# How many chunks to translate simultaneously
# Higher = faster but more API quota usage and potential rate limiting
# Recommended: 3-5 for Gemini API (avoid rate limits)
# PARALLEL_MAX_CONCURRENCY=3

# Target tokens per chunk (default: 12000)
# Each chunk will aim for this many tokens (chunks may be slightly larger/smaller)
# Should be well below model's max input tokens to leave room for prompts and context
# Recommended: 10000-15000 for most Gemini models
# PARALLEL_CHUNK_SIZE=12000

# Context overlap size (default: 3)
# Number of subtitle entries to include from previous/next chunks for context
# Higher = better coherence across chunks, but more redundant processing
# Recommended: 2-4 entries
# PARALLEL_CONTEXT_SIZE=3

# ======================
# Performance Tuning (ADVANCED)
# ======================

# OpenSubtitles V3 filename extraction (default: fast/disabled)
# By default, SubMaker uses fast URL-based filename extraction (~instant)
# When enabled, makes HEAD requests to get accurate filenames (~3-6s slower)
# This improves subtitle-to-video filename matching but adds significant latency
# Only enable if you need precise filename matching and can tolerate slower loading
# V3_EXTRACT_FILENAMES=true

# Subtitle Search Cache (in-memory, user-scoped)
# Caches subtitle search results from providers (OpenSubtitles, SubDL, SubSource)
# Each user gets their own isolated cache based on their config
# Cache automatically purges when user changes their configuration
# SUBTITLE_SEARCH_CACHE_MAX=15000           # Max cached searches (default: 15000)
# SUBTITLE_SEARCH_CACHE_TTL_MS=900000       # Cache lifetime in ms (default: 900000 = 15 minutes)

# Provider Search Timeout (early cutoff for slow providers)
# Maximum time to wait for subtitle provider API responses
# After this timeout, returns results from providers that responded in time
# Prevents slow/unresponsive providers from blocking the entire subtitle request
# Set to 0 to disable timeout (wait for all providers indefinitely)
# Default: 7000ms (7 seconds) - balances speed vs provider coverage
# PROVIDER_SEARCH_TIMEOUT_MS=7000

# Entry cache size (default: 100000)
# In-memory cache for individual subtitle entries
# Higher values = better cache hit rates but more RAM usage
# Estimate: 100K entries â‰ˆ 10-20MB RAM
# ENTRY_CACHE_SIZE=100000

# Partial cache flush timing (adaptive - optimized for user experience)
# First partial save: Quick initial feedback (default: 15000 = 15 seconds)
# Subsequent saves: Reduced I/O frequency (default: 30000 = 30 seconds)
#
# PARTIAL_FIRST_FLUSH_MS=15000      # First partial delivery (quick user feedback)
# PARTIAL_FLUSH_INTERVAL_MS=30000   # Subsequent partial deliveries (reduced I/O)

# Single-batch streaming throttles (Gemini)
# SINGLE_BATCH_LOG_ENTRY_INTERVAL=100          # Entries between debug log checkpoints for single-batch streaming
# SINGLE_BATCH_SRT_REBUILD_STEP_SMALL=150      # Partial SRT rebuild step when total entries <= threshold
# SINGLE_BATCH_SRT_REBUILD_STEP_LARGE=250      # Partial SRT rebuild step when total entries > threshold
# SINGLE_BATCH_SRT_REBUILD_LARGE_THRESHOLD=600 # Entry threshold to switch between small/large rebuild steps

# Subtitle List Limits (UI performance)
# Limit the number of subtitles shown per language in Stremio.
# Prevents UI slowdown while keeping the best-ranked results. Default: 8, Max: 50
# MAX_SUBTITLES_PER_LANGUAGE=8

# Language selection limits (configuration UI + server validation)
# MAX_SOURCE_LANGUAGES=3
# MAX_TARGET_LANGUAGES=6
# MAX_NO_TRANSLATION_LANGUAGES=9

# ======================
# Session Management
# ======================

# Session expiration time in milliseconds (sliding expiration - resets on each use)
# Default: 7776000000 (90 days / 3 months)
# Sessions only expire after this period of complete inactivity
SESSION_MAX_AGE=7776000000

# Auto-save interval for session persistence (in milliseconds)
# How often to save sessions to disk
# Default: 300000 (5 minutes)
SESSION_SAVE_INTERVAL=300000

# Path to store session data on disk
# Sessions are saved here and reloaded on server restart
# Default: ./data/sessions.json
SESSION_PERSISTENCE_PATH=./data/sessions.json

# Optional: enable session snapshots to disk when using Redis
# If enabled, sessions are snapshotted to disk and restored if Redis starts empty
# Default: false (off)
# SESSION_SNAPSHOT_ENABLED=false
# SESSION_SNAPSHOT_PATH=./data/sessions.json

# Maximum number of concurrent sessions in memory (global limit across all users)
# Default: 30000 (30k sessions)
# Uses LRU eviction: least recently used sessions are removed when limit is reached
# Set to 0 or omit to disable the limit (unbounded, not recommended for production)
# SESSION_MAX_SESSIONS=30000

# Maximum number of sessions in persistent storage (Redis/filesystem)
# Default: 60000 (60k sessions)
# When this limit is approached, oldest accessed sessions are purged (100 at a time)
# This prevents unbounded storage growth and disk/Redis exhaustion
# SESSION_STORAGE_MAX_SESSIONS=60000

# Maximum age for sessions in storage before purge (in milliseconds)
# Default: 7776000000 (90 days)
# Sessions not accessed within this time are eligible for purge during storage cleanup
# This works in conjunction with SESSION_STORAGE_MAX_SESSIONS for defense-in-depth
# SESSION_STORAGE_MAX_AGE=7776000000

# ======================
# Security Configuration
# ======================

# Additional allowed origins for CORS (comma-separated list)
# Use this to allow custom Stremio forks or alternative domains
# Default: empty (only official Stremio origins are allowed)
# Official origins already included: app.strem.io, web.stremio.com, etc.
# Example: ALLOWED_ORIGINS=https://my-custom-stremio.com,https://another-domain.com
# ALLOWED_ORIGINS=

# Additional user-agent hints treated as Stremio clients (comma-separated, case-insensitive)
# Defaults include: "stremio" and "needle" (Stremio desktop addon HTTP client)
# Use this to allow Stremio forks/platforms that change the user-agent
# Example: STREMIO_USER_AGENT_HINTS=stremio,kai,needle
# STREMIO_USER_AGENT_HINTS=

# Force session-based authentication even on localhost
# Set to 'true' to disable base64 encoding on localhost (for testing production behavior)
# Default: not set (allows base64 on localhost for development convenience)
# FORCE_SESSIONS=true

# Allow base64-encoded configs in production (NOT RECOMMENDED)
# Only enable this if you need backward compatibility
# Default: not set (base64 configs disabled in production)
# ALLOW_BASE64_CONFIG=true

# Allow custom AI provider endpoints to target internal/private IPs (e.g., localhost, 192.168.x.x)
# SECURITY WARNING: Leave disabled on public deployments to prevent SSRF attacks
# Enable ONLY for self-hosting scenarios where you need to connect to local LLMs (Ollama, LM Studio, etc.)
# Default: not set (internal endpoints blocked for security)
# ALLOW_INTERNAL_CUSTOM_ENDPOINTS=true

# ======================
# Download Throttling
# ======================
# Global throttle for subtitle downloads across ALL providers (OpenSubtitles, SubDL, SubSource)
# This is a sliding-window rate limiter that prevents 429 errors from provider APIs
# When the limit is reached, new downloads queue until a slot opens
# Default: 12 downloads per minute (safe for shared hosting)
# Increase to 30 for dedicated hosting with higher API quotas
# DOWNLOADS_PER_MINUTE=12

# Disable in-memory download cache (default: enabled)
# The download cache prevents repeated downloads of the same subtitle file
# within a 10-minute window (LRU cache, max 500MB / 5000 entries).
# Set to 'true' to disable completely (forces fresh download every time).
# Note: Disabling may increase bandwidth usage and provider API quota consumption.
# DISABLE_DOWNLOAD_CACHE=true

# ======================
# Prefetch/Burst Detection (Stremio Community/libmpv)
# ======================
# When Stremio opens the subtitle menu, it prefetches ALL subtitle URLs at once.
# This can trigger many downloads/translations simultaneously, wasting API quota.
# Burst detection prevents this by blocking requests that come in bursts.
#
# Translation burst detection (default: enabled)
# TRANSLATION_BURST_WINDOW_MS=1000    # Time window for burst detection (ms)
# TRANSLATION_BURST_THRESHOLD=3       # Number of requests to trigger burst mode
# DISABLE_TRANSLATION_BURST_DETECTION=true  # Set to 'true' to disable
#
# Download burst detection (default: enabled, less aggressive)
# DOWNLOAD_BURST_WINDOW_MS=500        # Time window for burst detection (ms)
# DOWNLOAD_BURST_THRESHOLD=5          # Number of requests to trigger burst mode
# DISABLE_DOWNLOAD_BURST_DETECTION=true     # Set to 'true' to disable

# ======================
# Logging Configuration
# ======================

# Write logs to file (enabled by default in production)
# Set to 'false' to disable file logging even in production
# Default: true in production, false in development
# LOG_TO_FILE=true

# Directory for log files (default: ./logs)
# LOG_DIR=./logs

# Log file name (default: app.log)
# LOG_BASENAME=app.log

# Maximum size of a single log file in MB (default: 10)
# LOG_MAX_SIZE_MB=10

# Maximum number of archived log files to keep (default: 100)
# LOG_MAX_FILES=100

# Maximum age of log files in days before auto-deletion (default: 14)
# LOG_MAX_AGE_DAYS=14

# ======================
# High-Performance Logging
# ======================

# Log sampling rate for high-load scenarios (0.0 to 1.0, default: 1.0 = no sampling)
# Example: 0.1 = log only 10% of messages (reduces I/O and CPU overhead)
# Useful for HA deployments with thousands of requests per second
# LOG_SAMPLE_RATE=1.0

# Only sample debug logs (default: false)
# When true, only debug logs are sampled; warn/error logs are always logged
# Recommended for production: set to true to ensure critical messages aren't lost
# LOG_SAMPLE_DEBUG_ONLY=true

# ======================
# Error Tracking (Sentry)
# ======================

# Sentry DSN for error tracking (optional)
# Get this from sentry.io when creating a Node.js project
# When set, actual code errors are sent to Sentry for monitoring
# Operational issues (rate limits, auth failures) are filtered out automatically
# SENTRY_DSN=https://your-key@sentry.io/project-id

# Sentry environment name (default: production)
# SENTRY_ENVIRONMENT=production

# Sentry error sample rate 0.0 to 1.0 (default: 1.0 = 100%)
# Lower this if you have too many errors being reported
# SENTRY_SAMPLE_RATE=1.0

# Disable Sentry even when DSN is set (default: true when DSN is set)
# SENTRY_ENABLED=false

# ======================
# Production Deployment
# ======================

# For VPS deployment, set these:
# NODE_ENV=production
# PORT=7001
# SESSION_MAX_AGE=7776000000

# Make sure your reverse proxy (nginx/apache) passes these headers:
# - X-Forwarded-Proto (for HTTPS detection)
# - X-Forwarded-For (for rate limiting)

# ======================
# Development/Testing
# ======================

# For local development, you can use defaults:
# NODE_ENV=development
# PORT=7001

# To test production session behavior on localhost:
# FORCE_SESSIONS=true

# ======================
# Branding Configuration
# ======================

# ElfHosted branding
# When enabled, addon name in Stremio will appear as "SubMaker | ElfHosted"
# This is used for the public ElfHosted instance at https://submaker.elfhosted.com
# ELFHOSTED=true
